@using Restaurant_site.Services
@inject CartService CartService
@inject NavigationManager NavigationManager
@implements IDisposable

@if (IsOpen)
{
    <div class="cart-modal-overlay" @onclick="Close">
        <div class="cart-modal-content" @onclick:stopPropagation="true">
            <div class="cart-modal-header">
                <h2>Корзина</h2>
                <button class="cart-modal-close" @onclick="Close">×</button>
            </div>

            <div class="cart-modal-body">
                @if (cartItems.Count == 0)
                {
                    <div class="cart-empty">
                        <p>Корзина пуста</p>
                        <p class="cart-empty-hint">Добавьте блюда из меню</p>
                    </div>
                }
                else
                {
                    <div class="cart-items-list">
                        @foreach (var item in cartItems)
                        {
                            <div class="cart-item-row">
                                <div class="cart-item-info">
                                    <h4>@item.Dish.Title</h4>
                                    <span class="cart-item-price">@item.Dish.Cost ₽</span>
                                </div>
                                <div class="cart-item-controls">
                                    <div class="cart-quantity-controls">
                                        <button class="cart-quantity-button" @onclick="() => DecreaseQuantity(item.Dish.IdDish)">−</button>
                                        <span class="cart-quantity-display">@item.Quantity</span>
                                        <button class="cart-quantity-button" @onclick="() => IncreaseQuantity(item.Dish.IdDish)">+</button>
                                    </div>
                                    <button class="cart-remove-button" @onclick="() => RemoveItem(item.Dish.IdDish)">
                                        <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                                            <path d="M2 4h12M5.333 4V2.667a1.333 1.333 0 0 1 1.334-1.334h2.666a1.333 1.333 0 0 1 1.334 1.334V4m2 0v9.333a1.333 1.333 0 0 1-1.334 1.334H4.667a1.333 1.333 0 0 1-1.334-1.334V4h9.334Z"
                                                  stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                                        </svg>
                                    </button>
                                    <span class="cart-item-total">@item.TotalPrice ₽</span>
                                </div>
                            </div>
                        }
                    </div>

                    <div class="cart-summary">
                        <div class="cart-total-row">
                            <span class="cart-total-label">Всего товаров:</span>
                            <span class="cart-total-value">@totalItems шт.</span>
                        </div>
                        <div class="cart-total-row cart-total-price">
                            <span class="cart-total-label">Итого:</span>
                            <span class="cart-total-value">@totalPrice ₽</span>
                        </div>
                        @if (!isMinOrderAmountMet)
                        {
                            <div class="cart-min-order-warning">
                                Минимальная сумма заказа: @CartService.MinOrderAmount ₽
                                <br/>
                                Добавьте еще на @(CartService.MinOrderAmount - totalPrice) ₽
                            </div>
                        }
                    </div>
                }
            </div>

            @if (cartItems.Count > 0)
            {
                <div class="cart-modal-footer">
                    <button class="cart-continue-shopping" @onclick="Close">
                        Продолжить покупки
                    </button>
                    <button class="cart-checkout-button"
                            @onclick="GoToCheckout"
                            disabled="@(!isMinOrderAmountMet)">
                        Перейти к оформлению
                    </button>
                </div>
            }
        </div>
    </div>
}

@code {
    [Parameter]
    public bool IsOpen { get; set; }

    [Parameter]
    public EventCallback<bool> IsOpenChanged { get; set; }

    private List<CartItem> cartItems = new();
    private int totalItems = 0;
    private decimal totalPrice = 0;
    private bool isMinOrderAmountMet = false;

    protected override async Task OnInitializedAsync()
    {
        CartService.CartChanged += OnCartChanged;
        await UpdateCartStateAsync();
    }

    private void OnCartChanged()
    {
         _ = InvokeAsync(async () =>
        {
            await UpdateCartStateAsync();
            StateHasChanged();
        });
    }

    private async Task UpdateCartStateAsync()
    {
        cartItems = await CartService.GetItemsAsync();
        totalItems = await CartService.GetTotalItemsAsync();
        totalPrice = await CartService.GetTotalPriceAsync();
        isMinOrderAmountMet = await CartService.IsMinOrderAmountMetAsync();
    }

    private async Task Close()
    {
        IsOpen = false;
        await IsOpenChanged.InvokeAsync(false);
    }

    private async Task IncreaseQuantity(int dishId)
    {
        var currentQuantity = await CartService.GetQuantityAsync(dishId);
        await CartService.UpdateQuantityAsync(dishId, currentQuantity + 1);
    }

    private async Task DecreaseQuantity(int dishId)
    {
        var currentQuantity = await CartService.GetQuantityAsync(dishId);
        await CartService.UpdateQuantityAsync(dishId, currentQuantity - 1);
    }

    private async Task RemoveItem(int dishId)
    {
        await CartService.RemoveFromCartAsync(dishId);
    }

    private async Task GoToCheckout()
    {
        await Close();
        NavigationManager.NavigateTo("/delivery");
    }

    public void Dispose()
    {
        CartService.CartChanged -= OnCartChanged;
    }
}
