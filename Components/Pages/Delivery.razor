@page "/delivery"
@rendermode InteractiveServer
@using Restaurant_site.Services
@inject CartService CartService
@inject IRestaurantService RestaurantService
@inject NavigationManager NavigationManager

<HomeButton />

<div class="container">
    <h1 class="restaurant-title">Restaurant</h1>

    <div class="content-section">
        <h2 class="section-title">Доставка</h2>
        <div class="section-content">
            <div class="delivery-container">
                    <div class="delivery-info">
                        <h3>Условия доставки</h3>
                        <ul class="delivery-list">
                            <li>Бесплатная доставка при заказе от 1500 ₽</li>
                            <li>Доставка по городу - 200 ₽</li>
                            <li>Среднее время доставки: 45-60 минут</li>
                            <li>Доставка работает ежедневно с 11:00 до 23:00</li>
                            <li>Минимальная сумма заказа: @CartService.MinOrderAmount ₽</li>
                            <li>Оплата наличными или картой курьеру</li>
                        </ul>
                    </div>

                    <div class="delivery-form-section">
                        @if (!orderPlaced)
                        {
                            @if (CartService.Items.Count == 0)
                            {
                                <div class="empty-cart-message">
                                    <p>Корзина пуста. Сначала выберите блюда из меню.</p>
                                    <button class="submit-button" @onclick="GoToMenu">
                                        Перейти в меню
                                    </button>
                                </div>
                            }
                            else
                            {
                                <div class="order-summary-section">
                                    <div class="order-summary-header">
                                        <h3>Ваш заказ</h3>
                                        <button class="edit-order-button" @onclick="GoToMenu">
                                            Добавить ещё блюд
                                        </button>
                                    </div>
                                    <div class="order-summary-items">
                                        @foreach (var item in CartService.Items)
                                        {
                                            <div class="order-summary-item">
                                                <span class="item-name">@item.Dish.Title</span>
                                                <span class="item-quantity">×@item.Quantity</span>
                                                <span class="item-price">@item.TotalPrice ₽</span>
                                            </div>
                                        }
                                    </div>
                                    <div class="order-summary-total">
                                        <span>Итого:</span>
                                        <span class="total-price">@CartService.TotalPrice ₽</span>
                                    </div>
                                    @if (CartService.TotalPrice >= 1500)
                                    {
                                        <div class="delivery-cost free">
                                            <span>Доставка:</span>
                                            <span>Бесплатно</span>
                                        </div>
                                    }
                                    else
                                    {
                                        <div class="delivery-cost">
                                            <span>Доставка:</span>
                                            <span>200 ₽</span>
                                        </div>
                                        <div class="order-summary-total">
                                            <span>К оплате:</span>
                                            <span class="total-price">@(CartService.TotalPrice + 200) ₽</span>
                                        </div>
                                    }
                                </div>

                                <div class="delivery-form">
                                    <h3>Данные для доставки</h3>
                                    @if (!string.IsNullOrEmpty(errorMessage))
                                    {
                                        <div class="error-message" style="color: red; margin-bottom: 10px; padding: 10px; background-color: #ffebee; border-radius: 4px;">
                                            @errorMessage
                                        </div>
                                    }
                                    <input type="text" @bind="deliveryData.Name" placeholder="Ваше имя" />
                                    <input type="tel" @bind="deliveryData.Phone" placeholder="Телефон" />
                                    <input type="text" @bind="deliveryData.Address" placeholder="Адрес доставки" />
                                    <input type="text" @bind="deliveryData.Apartment" placeholder="Квартира/Офис" />
                                    <textarea @bind="deliveryData.Comments" placeholder="Комментарий к заказу" rows="3"></textarea>
                                    <button class="submit-button" @onclick="PlaceOrder">
                                        Подтвердить заказ
                                    </button>
                                </div>
                            }
                        }
                        else
                        {
                            <div class="success-message">
                                <h3>Заказ принят!</h3>
                                <p>Номер заказа: <strong>@orderNumber</strong></p>
                                <p>Спасибо за заказ, @deliveryData.Name!</p>
                                <p>Ваш заказ будет доставлен по адресу:</p>
                                <p><strong>@deliveryData.Address@(string.IsNullOrWhiteSpace(deliveryData.Apartment) ? "" : ", " + deliveryData.Apartment)</strong></p>
                                <p>Сумма заказа: <strong>@finalTotal ₽</strong></p>
                                <p>Ожидайте звонка от курьера</p>
                                <button class="submit-button" @onclick="MakeNewOrder">
                                    Сделать новый заказ
                                </button>
                            </div>
                        }
                    </div>

                    <div class="payment-methods">
                        <h3>Способы оплаты</h3>
                        <div class="payment-icons">
                            <div class="payment-icon">Наличные</div>
                            <div class="payment-icon">Visa/MasterCard</div>
                            <div class="payment-icon">Мир</div>
                            <div class="payment-icon">Apple Pay</div>
                            <div class="payment-icon">Google Pay</div>
                        </div>
                    </div>
                </div>
            </div>
    </div>
</div>

<div class="navigation-container">
    <Navigation />
</div>

@code {
    private bool orderPlaced = false;
    private string orderNumber = "";
    private decimal finalTotal = 0;
    private string? errorMessage = null;

    private DeliveryData deliveryData = new DeliveryData();

    private class DeliveryData
    {
        public string Name { get; set; } = "";
        public string Phone { get; set; } = "";
        public string Address { get; set; } = "";
        public string Apartment { get; set; } = "";
        public string Comments { get; set; } = "";
    }

    protected override void OnInitialized()
    {
        CartService.CartChanged += OnCartChanged;
    }

    private void OnCartChanged()
    {
        StateHasChanged();
    }

    private void GoToMenu()
    {
        NavigationManager.NavigateTo("/menu");
    }

    private async Task PlaceOrder()
    {
        if (!string.IsNullOrWhiteSpace(deliveryData.Name) &&
            !string.IsNullOrWhiteSpace(deliveryData.Phone) &&
            !string.IsNullOrWhiteSpace(deliveryData.Address))
        {
            try
            {
                errorMessage = null;

                // 1. Получить или создать пользователя
                var user = await RestaurantService.GetUserByPhoneAsync(deliveryData.Phone);
                if (user == null)
                {
                    user = await RestaurantService.CreateUserAsync(new User
                    {
                        PhoneNum = deliveryData.Phone,
                        Name = deliveryData.Name
                    });
                }

                // 2. Создать заказ с блюдами из корзины
                var order = new Order
                {
                    PhoneNum = deliveryData.Phone,
                    Address = deliveryData.Address,
                    Date = DateTime.Now,
                    DishInOrders = CartService.Items.Select(item => new DishInOrder
                    {
                        IdDish = item.IdDish,
                        Quantity = item.Quantity
                    }).ToList()
                };

                // 3. Сохранить заказ в БД
                var success = await RestaurantService.CreateOrderAsync(order);

                if (!success)
                {
                    errorMessage = "Ошибка при сохранении заказа. Пожалуйста, попробуйте снова.";
                    return;
                }

                // Генерация номера заказа для отображения
                orderNumber = $"ORD-{DateTime.Now:yyyyMMdd}-{new Random().Next(1000, 9999)}";

                // Расчет финальной суммы
                var deliveryCost = CartService.TotalPrice >= 1500 ? 0 : 200;
                finalTotal = CartService.TotalPrice + deliveryCost;

                // 4. Очистка корзины после успешного сохранения
                await CartService.ClearCartAsync();

                orderPlaced = true;
            }
            catch (Exception ex)
            {
                errorMessage = $"Произошла ошибка: {ex.Message}. Пожалуйста, попробуйте снова.";
            }
        }
        else
        {
            errorMessage = "Пожалуйста, заполните все обязательные поля.";
        }
    }

    private void MakeNewOrder()
    {
        orderPlaced = false;
        deliveryData = new DeliveryData();
        NavigationManager.NavigateTo("/menu");
    }

    public void Dispose()
    {
        CartService.CartChanged -= OnCartChanged;
    }
}
