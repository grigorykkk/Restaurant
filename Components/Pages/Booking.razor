@page "/booking"
@rendermode InteractiveServer
@using Restaurant_site.Services
@inject IRestaurantService RestaurantService

<HomeButton />

<div class="container">
    <h1 class="restaurant-title">Restaurant</h1>

    <div class="content-section">
        <h2 class="section-title">Бронирование</h2>
        <div class="section-content">
            <div class="booking-container">
                <!-- Переключатель между окнами -->
                <div class="booking-tabs">
                    <button type="button" class="tab-button @(activeTab == "create" ? "active" : "")"
                            @onclick="@(() => { activeTab = "create"; showNotFound = false; ClearErrors(); StateHasChanged(); })">
                        Забронировать столик
                    </button>
                    <button type="button" class="tab-button @(activeTab == "check" ? "active" : "")"
                            @onclick="@(() => { activeTab = "check"; showNotFound = false; ClearErrors(); StateHasChanged(); })">
                        Проверить бронь
                    </button>
                </div>

                <!-- Окно 1: Забронировать столик -->
                @if (activeTab == "create")
                {
                    <div class="tab-content">
                        @if (!isBooked && !showTableSelection)
                        {
                            <form class="booking-form" @onsubmit="HandleBooking" @onsubmit:preventDefault="true">
                                @if (!string.IsNullOrEmpty(errorMessage))
                                {
                                    <div class="error-message">
                                        @errorMessage
                                    </div>
                                }

                                <!-- Поле имени -->
                                <div class="form-group">
                                    <label for="name">Ваше имя</label>
                                    <input type="text" id="name" @bind="bookingData.Name"
                                           @oninput="@((e) => OnNameInput(e))"
                                           class="@(fieldErrors.ContainsKey("name") ? "input-error" : "")" />
                                    @if (fieldErrors.ContainsKey("name"))
                                    {
                                        <div class="field-error">@fieldErrors["name"]</div>
                                    }
                                </div>

                                <!-- Поле телефона -->
                                <div class="form-group">
                                    <label for="phone">Телефон</label>
                                    <input type="tel" id="phone" @bind="bookingData.Phone"
                                           @oninput="@((e) => OnPhoneInput(e))"
                                           @onblur="@ValidatePhone"
                                           placeholder="+7 (___) ___-__-__"
                                           class="@(fieldErrors.ContainsKey("phone") ? "input-error" : "")" />
                                    @if (fieldErrors.ContainsKey("phone"))
                                    {
                                        <div class="field-error">@fieldErrors["phone"]</div>
                                    }
                                    <div class="hint">Формат: +7 (XXX) XXX-XX-XX</div>
                                </div>

                                <div class="form-row">
                                    <div class="form-group">
                                        <label for="date">Дата</label>
                                        <input type="date" id="date" @bind="bookingData.Date"
                                               min="@minDate" max="@maxDate"
                                               class="@(fieldErrors.ContainsKey("date") ? "input-error" : "")" />
                                        @if (fieldErrors.ContainsKey("date"))
                                        {
                                            <div class="field-error">@fieldErrors["date"]</div>
                                        }
                                    </div>

                                    <div class="form-group">
                                        <label for="time">Время</label>
                                        <input type="time" id="time" @bind="bookingData.Time"
                                               min="10:00" max="23:00"
                                               class="@(fieldErrors.ContainsKey("time") ? "input-error" : "")" />
                                        @if (fieldErrors.ContainsKey("time"))
                                        {
                                            <div class="field-error">@fieldErrors["time"]</div>
                                        }
                                        <div class="hint">Время работы: 10:00 - 23:00</div>
                                    </div>
                                </div>

                                <div class="form-group">
                                    <label for="guests">Количество гостей</label>
                                    <select id="guests" @bind="bookingData.Guests"
                                            class="@(fieldErrors.ContainsKey("guests") ? "input-error" : "")">
                                        <option value="">Выберите...</option>
                                        <option value="1">1 гость</option>
                                        <option value="2">2 гостя</option>
                                        <option value="3">3 гостя</option>
                                        <option value="4">4 гостя</option>
                                        <option value="5">5 гостей</option>
                                        <option value="6">6+ гостей</option>
                                    </select>
                                    @if (fieldErrors.ContainsKey("guests"))
                                    {
                                        <div class="field-error">@fieldErrors["guests"]</div>
                                    }
                                </div>

                                <button type="submit" class="submit-button" disabled="@(!IsFormValid())">Выбрать столик</button>
                            </form>
                        }
                        else if (showTableSelection)
                        {
                            <div class="table-selection">
                                <h3>Выберите столик</h3>
                                <p style="margin-bottom: 20px; color: #666;">
                                    Дата: @bookingData.Date.ToString("dd.MM.yyyy") |
                                    Время: @bookingData.Time.ToString("HH:mm") |
                                    Гостей: @bookingData.Guests
                                </p>

                                @if (availableTables.Count == 0)
                                {
                                    <div class="error-message">
                                        <p>К сожалению, на выбранное время нет доступных столиков.</p>
                                        <p>Попробуйте выбрать другое время.</p>
                                    </div>
                                    <button class="submit-button" @onclick="BackToBookingForm" style="margin-top: 15px;">
                                        Вернуться назад
                                    </button>
                                }
                                else
                                {
                                    <div class="tables-grid">
                                        @foreach (var tableAvailability in availableTables)
                                        {
                                            <div class="table-card @(tableAvailability.IsAvailableNow ? "available" : "available-later")">
                                                <div class="table-number">Столик №@tableAvailability.TableId</div>
                                                <div class="table-location">@tableAvailability.Location</div>
                                                <div class="table-capacity">До @tableAvailability.Capacity персон</div>
                                                <div class="table-status">
                                                    @if (tableAvailability.IsAvailableNow)
                                                    {
                                                        <span class="status-badge available">✓ Свободен</span>
                                                    }
                                                    else if (tableAvailability.IsAvailableInOneHour)
                                                    {
                                                        <span class="status-badge later">
                                                            Свободен с @tableAvailability.AvailableAt?.ToString("HH:mm")
                                                        </span>
                                                    }
                                                </div>
                                                <button class="table-select-btn" @onclick="() => SelectTable(tableAvailability)">
                                                    Выбрать
                                                </button>
                                            </div>
                                        }
                                    </div>
                                    <button class="submit-button secondary" @onclick="BackToBookingForm" style="margin-top: 20px;">
                                        Вернуться назад
                                    </button>
                                }
                            </div>
                        }
                        else
                        {
                            <div class="success-message">
                                <h3>Бронирование подтверждено!</h3>
                                <p>Имя: @bookingData.Name</p>
                                <p>Телефон: @FormatPhoneForDisplay(bookingData.Phone)</p>
                                <p>Дата: @bookingData.Date.ToString("dd.MM.yyyy")</p>
                                <p>Время: @bookingData.Time.ToString("HH:mm")</p>
                                <p>Количество гостей: @bookingData.Guests</p>
                                <p>Столик №@bookingData.TableId (@bookingData.TableLocation, до @bookingData.TableCapacity персон)</p>
                                <p class="booking-code">Код брони: @bookingData.Name.ToUpper()@(new string(bookingData.Phone.Where(char.IsDigit).ToArray()).Substring(7))</p>
                                <p>Мы ждем вас! В случае изменений, пожалуйста, позвоните нам.</p>
                                <button class="submit-button" @onclick="ResetBooking">Создать новую бронь</button>
                            </div>
                        }
                    </div>
                }
                else if (activeTab == "check")
                {
                    <div class="tab-content">
                        @if (!bookingFound)
                        {
                            <div class="booking-form">
                                <div class="form-group">
                                    <label for="checkName">Ваше имя</label>
                                    <input type="text" id="checkName" @bind-value="nameCheck" @bind-value:event="oninput"
                                           placeholder="Введите имя"
                                           class="@(fieldErrors.ContainsKey("checkName") ? "input-error" : "")" />
                                    @if (fieldErrors.ContainsKey("checkName"))
                                    {
                                        <div class="field-error">@fieldErrors["checkName"]</div>
                                    }
                                </div>

                                <div class="form-group">
                                    <label for="checkPhone">Последние 4 цифры телефона</label>
                                    <input type="text" id="checkPhone" @bind-value="phoneCheck" @bind-value:event="oninput"
                                           placeholder="____" maxlength="4"
                                           class="@(fieldErrors.ContainsKey("checkPhone") ? "input-error" : "")" />
                                    @if (fieldErrors.ContainsKey("checkPhone"))
                                    {
                                        <div class="field-error">@fieldErrors["checkPhone"]</div>
                                    }
                                </div>

                                <button type="button" class="submit-button" @onclick="CheckBooking"
                                        disabled="@(!IsCheckFormValid())">
                                    Проверить бронь
                                </button>

                                <p style="margin-top: 10px; color: #999; font-size: 14px;">Всего броней: @totalBookingsCount</p>
                            </div>

                            @if (showNotFound)
                            {
                                <div class="error-message">
                                    <p>Бронь не найдена. Проверьте правильность введенных данных.</p>
                                    <p style="font-size: 12px;">Имя: "@nameCheck", Телефон (последние 4 цифры): "@phoneCheck"</p>
                                </div>
                            }
                        }
                        else
                        {
                            <div class="success-message">
                                <h3>Информация о брони</h3>
                                <p>Имя: @foundBooking.Name</p>
                                <p>Телефон: @FormatPhoneForDisplay(foundBooking.Phone)</p>
                                <p>Дата: @foundBooking.Date.ToString("dd.MM.yyyy")</p>
                                <p>Время: @foundBooking.Time.ToString("HH:mm")</p>
                                <p>Количество гостей: @foundBooking.Guests</p>
                                @if (foundBooking.TableId > 0)
                                {
                                    <p>Столик №@foundBooking.TableId (@foundBooking.TableLocation, до @foundBooking.TableCapacity персон)</p>
                                }
                                <button class="submit-button" @onclick="ResetCheck">Проверить другую бронь</button>
                            </div>
                        }
                    </div>
                }
            </div>
        </div>
    </div>
</div>

<div class="navigation-container">
    <Navigation />
</div>

<style>
    .input-error {
        border-color: #dc3545 !important;
        background-color: #fff5f5;
        box-shadow: 0 0 0 0.2rem rgba(220, 53, 69, 0.25);
    }

    .field-error {
        color: #dc3545;
        font-size: 12px;
        margin-top: 4px;
        font-weight: 500;
    }

    .submit-button:disabled {
        background-color: #6c757d !important;
        cursor: not-allowed !important;
        opacity: 0.6 !important;
        transform: none !important;
    }

        .submit-button:disabled:hover {
            background-color: #6c757d !important;
            transform: none !important;
        }

    .error-message {
        color: #dc3545;
        background-color: #f8d7da;
        border: 1px solid #f5c6cb;
        border-radius: 4px;
        padding: 12px;
        margin-bottom: 20px;
        font-size: 14px;
    }    
</style>

@code {
    private string activeTab = "create";
    private bool isBooked = false;
    private bool bookingFound = false;
    private bool showNotFound = false;
    private string phoneCheck = "";
    private bool showTableSelection = false;
    private List<TableAvailability> availableTables = new List<TableAvailability>();
    private string nameCheck = "";
    private string? errorMessage = null;
    private List<Table> tables = new List<Table>();
    private int totalBookingsCount = 0;

    // Валидация
    private Dictionary<string, string> fieldErrors = new Dictionary<string, string>();
    private string minDate = DateTime.Today.ToString("yyyy-MM-dd");
    private string maxDate = DateTime.Today.AddMonths(3).ToString("yyyy-MM-dd");

    private BookingData bookingData = new BookingData
    {
        Date = DateOnly.FromDateTime(DateTime.Today.AddDays(1)),
        Time = new TimeOnly(19, 0)
    };

    private BookingData foundBooking = new BookingData();

    protected override async Task OnInitializedAsync()
    {
        tables = await RestaurantService.GetTablesAsync();
        totalBookingsCount = tables.Sum(t => t.Reservations?.Count ?? 0);
    }

    private class BookingData
    {
        public string Name { get; set; } = "";
        public string Phone { get; set; } = "";
        public DateOnly Date { get; set; }
        public TimeOnly Time { get; set; }
        public string Guests { get; set; } = "";
        public int TableId { get; set; }
        public string? TableLocation { get; set; }
        public int TableCapacity { get; set; }
    }

    private class TableAvailability
    {
        public int TableId { get; set; }
        public string Location { get; set; } = "";
        public int Capacity { get; set; }
        public bool IsAvailableNow { get; set; }
        public bool IsAvailableInOneHour { get; set; }
        public TimeOnly? AvailableAt { get; set; }
    }

    // ========== ВАЛИДАЦИЯ ==========

    private void ClearErrors()
    {
        fieldErrors.Clear();
        errorMessage = null;
    }

    private void AddFieldError(string fieldName, string message)
    {
        fieldErrors[fieldName] = message;
    }

    private void RemoveFieldError(string fieldName)
    {
        if (fieldErrors.ContainsKey(fieldName))
        {
            fieldErrors.Remove(fieldName);
        }
    }

    // Валидация имени
    private void OnNameInput(ChangeEventArgs e)
    {
        var value = e.Value?.ToString() ?? "";
        bookingData.Name = value;

        RemoveFieldError("name");

        if (string.IsNullOrWhiteSpace(value))
        {
            AddFieldError("name", "Имя обязательно для заполнения");
        }
        else if (value.Length < 2)
        {
            AddFieldError("name", "Имя должно содержать минимум 2 символа");
        }
        else if (value.Length > 50)
        {
            AddFieldError("name", "Имя не должно превышать 50 символов");
        }
        else if (!System.Text.RegularExpressions.Regex.IsMatch(value, @"^[a-zA-Zа-яА-ЯёЁ\s\-]+$"))
        {
            AddFieldError("name", "Имя может содержать только буквы, пробелы и дефисы");
        }
    }

    // Валидация телефона
    private void OnPhoneInput(ChangeEventArgs e)
    {
        var value = e.Value?.ToString() ?? "";

        // Автоматическое форматирование телефона
        var formattedPhone = FormatPhoneInput(value);
        bookingData.Phone = formattedPhone;

        RemoveFieldError("phone");

        // Базовая валидация длины
        var digitsOnly = new string(formattedPhone.Where(char.IsDigit).ToArray());
        if (digitsOnly.Length < 11 && digitsOnly.Length > 0)
        {
            AddFieldError("phone", "Номер телефона должен содержать 11 цифр");
        }
    }

    private void ValidatePhone()
    {
        RemoveFieldError("phone");

        if (string.IsNullOrWhiteSpace(bookingData.Phone))
        {
            AddFieldError("phone", "Телефон обязателен для заполнения");
            return;
        }

        var digitsOnly = new string(bookingData.Phone.Where(char.IsDigit).ToArray());

        // Проверка длины
        if (digitsOnly.Length != 11)
        {
            AddFieldError("phone", "Номер телефона должен содержать 11 цифр");
            return;
        }

        // Проверка кода страны
        if (!digitsOnly.StartsWith("7"))
        {
            AddFieldError("phone", "Номер должен начинаться с 7 (Россия)");
            return;
        }

        // Проверка формата
        if (!IsValidPhoneFormat(bookingData.Phone))
        {
            AddFieldError("phone", "Неверный формат номера телефона");
        }
    }

    // Валидация даты и времени
    private void ValidateDateTime()
    {
        RemoveFieldError("date");
        RemoveFieldError("time");

        // Проверка даты
        if (bookingData.Date < DateOnly.FromDateTime(DateTime.Today))
        {
            AddFieldError("date", "Дата не может быть в прошлом");
        }
        else if (bookingData.Date > DateOnly.FromDateTime(DateTime.Today.AddMonths(3)))
        {
            AddFieldError("date", "Бронирование возможно не более чем за 3 месяца");
        }

        // Проверка времени
        var minTime = new TimeOnly(10, 0);
        var maxTime = new TimeOnly(23, 0);

        if (bookingData.Time < minTime || bookingData.Time > maxTime)
        {
            AddFieldError("time", "Время работы ресторана: 10:00 - 23:00");
        }

        // Проверка что дата и время не в прошлом
        var selectedDateTime = bookingData.Date.ToDateTime(bookingData.Time);
        if (selectedDateTime < DateTime.Now)
        {
            AddFieldError("date", "Выбранное время уже прошло");
            AddFieldError("time", "Выбранное время уже прошло");
        }
    }

    // Валидация количества гостей
    private void ValidateGuests()
    {
        RemoveFieldError("guests");

        if (string.IsNullOrEmpty(bookingData.Guests))
        {
            AddFieldError("guests", "Выберите количество гостей");
        }
    }

    // Валидация формы проверки брони
    private void ValidateCheckForm()
    {
        RemoveFieldError("checkName");
        RemoveFieldError("checkPhone");

        if (string.IsNullOrWhiteSpace(nameCheck))
        {
            AddFieldError("checkName", "Введите имя для поиска");
        }

        if (string.IsNullOrWhiteSpace(phoneCheck))
        {
            AddFieldError("checkPhone", "Введите последние 4 цифры телефона");
        }
        else if (phoneCheck.Length != 4 || !phoneCheck.All(char.IsDigit))
        {
            AddFieldError("checkPhone", "Введите ровно 4 цифры");
        }
    }

    // Проверка валидности основной формы
    private bool IsFormValid()
    {
        ValidateDateTime();
        ValidateGuests();

        return string.IsNullOrWhiteSpace(bookingData.Name) == false &&
               string.IsNullOrWhiteSpace(bookingData.Phone) == false &&
               string.IsNullOrWhiteSpace(bookingData.Guests) == false &&
               fieldErrors.Count == 0;
    }

    // Проверка валидности формы проверки
    private bool IsCheckFormValid()
    {
        return !string.IsNullOrWhiteSpace(nameCheck) &&
               !string.IsNullOrWhiteSpace(phoneCheck) &&
               phoneCheck.Length == 4 &&
               phoneCheck.All(char.IsDigit);
    }

    // ========== ФОРМАТИРОВАНИЕ ТЕЛЕФОНА ==========

    private string FormatPhoneInput(string input)
    {
        // Удаляем все нецифровые символы
        var digits = new string(input.Where(char.IsDigit).ToArray());

        // Если первый символ 8, заменяем на 7
        if (digits.StartsWith("8") && digits.Length > 0)
        {
            digits = "7" + digits.Substring(1);
        }

        // Ограничиваем длину
        if (digits.Length > 11)
        {
            digits = digits.Substring(0, 11);
        }

        // Форматируем по шаблону
        if (digits.Length == 0) return "";
        if (digits.Length == 1) return $"+7 ({digits}";
        if (digits.Length <= 4) return $"+7 ({digits.Substring(1)}";
        if (digits.Length <= 7) return $"+7 ({digits.Substring(1, 3)}) {digits.Substring(4)}";
        if (digits.Length <= 9) return $"+7 ({digits.Substring(1, 3)}) {digits.Substring(4, 3)}-{digits.Substring(7)}";

        return $"+7 ({digits.Substring(1, 3)}) {digits.Substring(4, 3)}-{digits.Substring(7, 2)}-{digits.Substring(9)}";
    }

    private bool IsValidPhoneFormat(string phone)
    {
        // Проверяем соответствие формату +7 (XXX) XXX-XX-XX
        var pattern = @"^\+7\s\(\d{3}\)\s\d{3}-\d{2}-\d{2}$";
        return System.Text.RegularExpressions.Regex.IsMatch(phone, pattern);
    }

    private string FormatPhoneForDisplay(string phone)
    {
        if (string.IsNullOrWhiteSpace(phone)) return "";

        var digits = new string(phone.Where(char.IsDigit).ToArray());
        if (digits.Length != 11) return phone;

        return $"+7 ({digits.Substring(1, 3)}) {digits.Substring(4, 3)}-{digits.Substring(7, 2)}-{digits.Substring(9)}";
    }

    // ========== ОСНОВНЫЕ МЕТОДЫ ==========

    private async Task HandleBooking()
    {
        ClearErrors();

        // Валидация всех полей
        OnNameInput(new ChangeEventArgs { Value = bookingData.Name });
        ValidatePhone();
        ValidateDateTime();
        ValidateGuests();

        if (fieldErrors.Count > 0)
        {
            errorMessage = "Пожалуйста, исправьте ошибки в форме";
            return;
        }

        // Переходим к выбору столика
        await ProceedToTableSelection();
    }

    private async Task ProceedToTableSelection()
    {
        // Получаем количество гостей
        int guestCount = int.TryParse(bookingData.Guests, out int count) ? count : 6;

        // Получаем доступные столики из БД
        availableTables = await GetAvailableTables(bookingData.Date, bookingData.Time, guestCount);

        // Показываем экран выбора столика
        showTableSelection = true;
    }

    private async Task SelectTable(TableAvailability tableAvailability)
    {
        try
        {
            errorMessage = null;

            // 1. Проверяем доступность стола
            var reservationDateTime = bookingData.Date.ToDateTime(bookingData.Time);
            var isAvailable = await RestaurantService.CheckTableAvailabilityAsync(
                tableAvailability.TableId,
                reservationDateTime
            );

            if (!isAvailable)
            {
                errorMessage = "К сожалению, этот столик уже забронирован на выбранное время. Пожалуйста, выберите другой столик или время.";
                // Обновляем список доступных столиков
                await ProceedToTableSelection();
                return;
            }

            // 2. Получить или создать пользователя
            var user = await RestaurantService.GetUserByPhoneAsync(bookingData.Phone);
            if (user == null)
            {
                user = await RestaurantService.CreateUserAsync(new User
                {
                    PhoneNum = bookingData.Phone,
                    Name = bookingData.Name
                });
            }

            // 3. Создать бронирование
            var guestCount = int.TryParse(bookingData.Guests, out int count) ? count : 6;
            var reservation = new Reservation
            {
                PhoneNum = bookingData.Phone,
                Date = reservationDateTime,
                GuestCount = guestCount,
                IdTable = tableAvailability.TableId
            };

            // 4. Сохранить в БД
            var success = await RestaurantService.CreateReservationAsync(reservation);

            if (!success)
            {
                errorMessage = "Ошибка при сохранении бронирования. Пожалуйста, попробуйте снова.";
                return;
            }

            // Сохраняем информацию о выбранном столике для отображения
            bookingData.TableId = tableAvailability.TableId;
            bookingData.TableLocation = tableAvailability.Location;
            bookingData.TableCapacity = tableAvailability.Capacity;

            // Обновляем количество бронирований
            totalBookingsCount++;

            // Скрываем выбор столиков и показываем подтверждение
            showTableSelection = false;
            isBooked = true;
        }
        catch (Exception ex)
        {
            errorMessage = $"Произошла ошибка: {ex.Message}. Пожалуйста, попробуйте снова.";
        }
    }

    private void BackToBookingForm()
    {
        showTableSelection = false;
    }

    private void ResetBooking()
    {
        isBooked = false;
        showTableSelection = false;
        availableTables.Clear();
        bookingData = new BookingData
        {
            Date = DateOnly.FromDateTime(DateTime.Today.AddDays(1)),
            Time = new TimeOnly(19, 0)
        };
        ClearErrors();
    }

    private async Task CheckBooking()
    {
        ClearErrors();
        ValidateCheckForm();

        if (fieldErrors.Count > 0)
        {
            return;
        }

        showNotFound = false;

        try
        {
            var allReservations = await RestaurantService.GetAllReservationsAsync();
            var reservation = allReservations.FirstOrDefault(r =>
            {
                if (r.User == null) return false;

                var phoneDigits = new string(r.User.PhoneNum.Where(char.IsDigit).ToArray());
                var checkDigits = new string(phoneCheck.Where(char.IsDigit).ToArray());
                var phoneMatch = phoneDigits.EndsWith(checkDigits);
                var nameMatch = r.User.Name.Equals(nameCheck, StringComparison.OrdinalIgnoreCase);

                return phoneMatch && nameMatch;
            });

            if (reservation != null)
            {
                var dateOnly = DateOnly.FromDateTime(reservation.Date);
                var timeOnly = TimeOnly.FromDateTime(reservation.Date);
                var location = reservation.Table?.TableType?.Title ?? "Зал";

                foundBooking = new BookingData
                {
                    Name = reservation.User?.Name ?? "",
                    Phone = reservation.User?.PhoneNum ?? "",
                    Date = dateOnly,
                    Time = timeOnly,
                    Guests = reservation.GuestCount.ToString(),
                    TableId = reservation.IdTable,
                    TableLocation = location,
                    TableCapacity = reservation.Table?.SeatsCount ?? 0
                };

                bookingFound = true;
            }
            else
            {
                showNotFound = true;
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Ошибка при поиске бронирования: {ex.Message}";
            showNotFound = true;
        }
    }

    private void ResetCheck()
    {
        bookingFound = false;
        phoneCheck = "";
        nameCheck = "";
        showNotFound = false;
        ClearErrors();
    }

    private async Task<List<TableAvailability>> GetAvailableTables(DateOnly date, TimeOnly time, int guestCount)
    {
        var availableTables = new List<TableAvailability>();
        var requestedDateTime = date.ToDateTime(time);

        // Обновляем данные таблиц из БД
        tables = await RestaurantService.GetTablesAsync();

        // Проверяем каждый столик
        foreach (var table in tables)
        {
            // Получаем название локации из TableType
            var location = table.TableType?.Title ?? "Зал";

            // Фильтруем по вместимости - столик должен вмещать количество гостей
            int requiredCapacity = guestCount > 6 ? 6 : guestCount;

            if (table.SeatsCount < requiredCapacity)
                continue;

            // Проверяем, занят ли столик на это время (±2 часа)
            var startTime = requestedDateTime.AddHours(-2);
            var endTime = requestedDateTime.AddHours(2);

            var conflictingReservation = table.Reservations?.FirstOrDefault(r =>
                r.Date >= startTime && r.Date <= endTime
            );

            var availability = new TableAvailability
            {
                TableId = table.IdTable,
                Location = location,
                Capacity = table.SeatsCount,
                IsAvailableNow = conflictingReservation == null,
                IsAvailableInOneHour = false,
                AvailableAt = null
            };

            // Если столик занят сейчас, проверяем, освободится ли он через час
            if (conflictingReservation != null)
            {
                var bookingEndTime = TimeOnly.FromDateTime(conflictingReservation.Date.AddHours(2));
                var oneHourLater = time.AddHours(1);

                if (bookingEndTime <= oneHourLater)
                {
                    availability.IsAvailableInOneHour = true;
                    availability.AvailableAt = bookingEndTime;
                }
            }

            // Добавляем столик если он доступен сейчас или через час
            if (availability.IsAvailableNow || availability.IsAvailableInOneHour)
            {
                availableTables.Add(availability);
            }
        }

        // Сортируем: сначала доступные сейчас, потом по вместимости
        return availableTables
            .OrderByDescending(t => t.IsAvailableNow)
            .ThenBy(t => t.Capacity)
            .ToList();
    }
}