@page "/booking"
@rendermode InteractiveServer
@using Restaurant_site.Services
@inject IRestaurantService RestaurantService

<HomeButton />

<div class="container">
    <h1 class="restaurant-title">Restaurant</h1>

    <div class="content-section">
        <h2 class="section-title">Бронирование</h2>
        <div class="section-content">
            <div class="booking-container">
                    <!-- Переключатель между окнами -->
                    <div class="booking-tabs">
                        <button type="button" class="tab-button @(activeTab == "create" ? "active" : "")"
                                @onclick="@(() => { activeTab = "create"; showNotFound = false; StateHasChanged(); })">
                            Забронировать столик
                        </button>
                        <button type="button" class="tab-button @(activeTab == "check" ? "active" : "")"
                                @onclick="@(() => { activeTab = "check"; showNotFound = false; StateHasChanged(); })">
                            Проверить бронь
                        </button>
                    </div>

                    <!-- Окно 1: Забронировать столик -->
                    @if (activeTab == "create")
                    {
                        <div class="tab-content">
                            @if (!isBooked && !showTableSelection)
                            {
                                <form class="booking-form" @onsubmit="HandleBooking" @onsubmit:preventDefault="true">
                                    @if (!string.IsNullOrEmpty(errorMessage))
                                    {
                                        <div class="error-message" style="color: red; margin-bottom: 15px; padding: 10px; background-color: #ffebee; border-radius: 4px;">
                                            @errorMessage
                                        </div>
                                    }
                                    <div class="form-group">
                                        <label for="name">Ваше имя</label>
                                        <input type="text" id="name" @bind="bookingData.Name" required />
                                    </div>

                                    <div class="form-group">
                                        <label for="phone">Телефон</label>
                                        <input type="tel" id="phone" @bind="bookingData.Phone"
                                               placeholder="+7 (___) ___-__-__" required />
                                    </div>

                                    <div class="form-row">
                                        <div class="form-group">
                                            <label for="date">Дата</label>
                                            <input type="date" id="date" @bind="bookingData.Date" required />
                                        </div>

                                        <div class="form-group">
                                            <label for="time">Время</label>
                                            <input type="time" id="time" @bind="bookingData.Time" required />
                                        </div>
                                    </div>

                                    <div class="form-group">
                                        <label for="guests">Количество гостей</label>
                                        <select id="guests" @bind="bookingData.Guests" required>
                                            <option value="">Выберите...</option>
                                            <option value="1">1 гость</option>
                                            <option value="2">2 гостя</option>
                                            <option value="3">3 гостя</option>
                                            <option value="4">4 гостя</option>
                                            <option value="5">5 гостей</option>
                                            <option value="6">6+ гостей</option>
                                        </select>
                                    </div>

                                    <button type="submit" class="submit-button">Выбрать столик</button>
                                </form>
                            }
                            else if (showTableSelection)
                            {
                                <div class="table-selection">
                                    <h3>Выберите столик</h3>
                                    <p style="margin-bottom: 20px; color: #666;">
                                        Дата: @bookingData.Date.ToString("dd.MM.yyyy") |
                                        Время: @bookingData.Time.ToString("HH:mm") |
                                        Гостей: @bookingData.Guests
                                    </p>

                                    @if (availableTables.Count == 0)
                                    {
                                        <div class="error-message">
                                            <p>К сожалению, на выбранное время нет доступных столиков.</p>
                                            <p>Попробуйте выбрать другое время.</p>
                                        </div>
                                        <button class="submit-button" @onclick="BackToBookingForm" style="margin-top: 15px;">
                                            Вернуться назад
                                        </button>
                                    }
                                    else
                                    {
                                        <div class="tables-grid">
                                            @foreach (var tableAvailability in availableTables)
                                            {
                                                <div class="table-card @(tableAvailability.IsAvailableNow ? "available" : "available-later")">
                                                    <div class="table-number">Столик №@tableAvailability.TableId</div>
                                                    <div class="table-location">@tableAvailability.Location</div>
                                                    <div class="table-capacity">До @tableAvailability.Capacity персон</div>
                                                    <div class="table-status">
                                                        @if (tableAvailability.IsAvailableNow)
                                                        {
                                                            <span class="status-badge available">✓ Свободен</span>
                                                        }
                                                        else if (tableAvailability.IsAvailableInOneHour)
                                                        {
                                                            <span class="status-badge later">
                                                                Свободен с @tableAvailability.AvailableAt?.ToString("HH:mm")
                                                            </span>
                                                        }
                                                    </div>
                                                    <button class="table-select-btn" @onclick="() => SelectTable(tableAvailability)">
                                                        Выбрать
                                                    </button>
                                                </div>
                                            }
                                        </div>
                                        <button class="submit-button secondary" @onclick="BackToBookingForm" style="margin-top: 20px;">
                                            Вернуться назад
                                        </button>
                                    }
                                </div>
                            }
                            else
                            {
                                <div class="success-message">
                                    <h3>Бронирование подтверждено!</h3>
                                    <p>Имя: @bookingData.Name</p>
                                    <p>Телефон: @bookingData.Phone</p>
                                    <p>Дата: @bookingData.Date.ToString("dd.MM.yyyy")</p>
                                    <p>Время: @bookingData.Time.ToString("HH:mm")</p>
                                    <p>Количество гостей: @bookingData.Guests</p>
                                    <p>Столик №@bookingData.TableId (@bookingData.TableLocation, до @bookingData.TableCapacity персон)</p>
                                    <p class="booking-code">Код брони: ваше имя + последние 4 цифры телефона</p>
                                    <p>Мы ждем вас! В случае изменений, пожалуйста, позвоните нам.</p>
                                    <button class="submit-button" @onclick="ResetBooking">Создать новую бронь</button>
                                </div>
                            }
                        </div>
                    }
                    else if (activeTab == "check")
                    {
                        <div class="tab-content">
                            @if (!bookingFound)
                            {
                                <div class="booking-form">
                                    <div class="form-group">
                                        <label for="checkName">Ваше имя</label>
                                        <input type="text" id="checkName" @bind-value="nameCheck" @bind-value:event="oninput"
                                               placeholder="Введите имя" required />
                                    </div>

                                    <div class="form-group">
                                        <label for="checkPhone">Последние 4 цифры телефона</label>
                                        <input type="text" id="checkPhone" @bind-value="phoneCheck" @bind-value:event="oninput"
                                               placeholder="____" maxlength="4" required />
                                    </div>

                                    <button type="button" class="submit-button" @onclick="CheckBooking">Проверить бронь</button>

                                    <p style="margin-top: 10px; color: #999; font-size: 14px;">Всего броней: @totalBookingsCount</p>
                                </div>

                                @if (showNotFound)
                                {
                                    <div class="error-message">
                                        <p>Бронь не найдена. Проверьте правильность введенных данных.</p>
                                        <p style="font-size: 12px;">Имя: "@nameCheck", Телефон (последние 4 цифры): "@phoneCheck"</p>
                                    </div>
                                }
                            }
                            else
                            {
                                <div class="success-message">
                                    <h3>Информация о брони</h3>
                                    <p>Имя: @foundBooking.Name</p>
                                    <p>Телефон: @foundBooking.Phone</p>
                                    <p>Дата: @foundBooking.Date.ToString("dd.MM.yyyy")</p>
                                    <p>Время: @foundBooking.Time.ToString("HH:mm")</p>
                                    <p>Количество гостей: @foundBooking.Guests</p>
                                    @if (foundBooking.TableId > 0)
                                    {
                                        <p>Столик №@foundBooking.TableId (@foundBooking.TableLocation, до @foundBooking.TableCapacity персон)</p>
                                    }
                                    <button class="submit-button" @onclick="ResetCheck">Проверить другую бронь</button>
                                </div>
                            }
                        </div>
                    }
                </div>
            </div>
    </div>
</div>

<div class="navigation-container">
    <Navigation />
</div>

@code {
    private string activeTab = "create";
    private bool isBooked = false;
    private bool bookingFound = false;
    private bool showNotFound = false;
    private string phoneCheck = "";
    private bool showTableSelection = false;
    private List<TableAvailability> availableTables = new List<TableAvailability>();
    private string nameCheck = "";
    private string? errorMessage = null;
    private List<Table> tables = new List<Table>();
    private int totalBookingsCount = 0;

    private BookingData bookingData = new BookingData
    {
        Date = DateOnly.FromDateTime(DateTime.Today.AddDays(1)),
        Time = new TimeOnly(19, 0)
    };

    private BookingData foundBooking = new BookingData();

    protected override async Task OnInitializedAsync()
    {
        // Загружаем столы из БД
        tables = await RestaurantService.GetTablesAsync();

        // Получаем общее количество бронирований (для отладки)
        totalBookingsCount = tables.Sum(t => t.Reservations?.Count ?? 0);
    }

    private class BookingData
    {
        public string Name { get; set; } = "";
        public string Phone { get; set; } = "";
        public DateOnly Date { get; set; }
        public TimeOnly Time { get; set; }
        public string Guests { get; set; } = "";
        public int TableId { get; set; }
        public string? TableLocation { get; set; }
        public int TableCapacity { get; set; }
    }

    private class TableAvailability
    {
        public int TableId { get; set; }
        public string Location { get; set; } = "";
        public int Capacity { get; set; }
        public bool IsAvailableNow { get; set; }
        public bool IsAvailableInOneHour { get; set; }
        public TimeOnly? AvailableAt { get; set; }
    }

    private async Task HandleBooking()
    {
        // Переходим к выбору столика
        await ProceedToTableSelection();
    }

    private async Task ProceedToTableSelection()
    {
        // Получаем количество гостей
        int guestCount = int.TryParse(bookingData.Guests, out int count) ? count : 6;

        // Получаем доступные столики из БД
        availableTables = await GetAvailableTables(bookingData.Date, bookingData.Time, guestCount);

        // Показываем экран выбора столика
        showTableSelection = true;
    }

    private async Task SelectTable(TableAvailability tableAvailability)
    {
        try
        {
            errorMessage = null;

            // 1. Проверяем доступность стола
            var reservationDateTime = bookingData.Date.ToDateTime(bookingData.Time);
            var isAvailable = await RestaurantService.CheckTableAvailabilityAsync(
                tableAvailability.TableId,
                reservationDateTime
            );

            if (!isAvailable)
            {
                errorMessage = "К сожалению, этот столик уже забронирован на выбранное время. Пожалуйста, выберите другой столик или время.";
                // Обновляем список доступных столиков
                await ProceedToTableSelection();
                return;
            }

            // 2. Получить или создать пользователя
            var user = await RestaurantService.GetUserByPhoneAsync(bookingData.Phone);
            if (user == null)
            {
                user = await RestaurantService.CreateUserAsync(new User
                {
                    PhoneNum = bookingData.Phone,
                    Name = bookingData.Name
                });
            }

            // 3. Создать бронирование
            var guestCount = int.TryParse(bookingData.Guests, out int count) ? count : 6;
            var reservation = new Reservation
            {
                PhoneNum = bookingData.Phone,
                Date = reservationDateTime,
                GuestCount = guestCount,
                IdTable = tableAvailability.TableId
            };

            // 4. Сохранить в БД
            var success = await RestaurantService.CreateReservationAsync(reservation);

            if (!success)
            {
                errorMessage = "Ошибка при сохранении бронирования. Пожалуйста, попробуйте снова.";
                return;
            }

            // Сохраняем информацию о выбранном столике для отображения
            bookingData.TableId = tableAvailability.TableId;
            bookingData.TableLocation = tableAvailability.Location;
            bookingData.TableCapacity = tableAvailability.Capacity;

            // Обновляем количество бронирований
            totalBookingsCount++;

            // Скрываем выбор столиков и показываем подтверждение
            showTableSelection = false;
            isBooked = true;
        }
        catch (Exception ex)
        {
            errorMessage = $"Произошла ошибка: {ex.Message}. Пожалуйста, попробуйте снова.";
        }
    }

    private void BackToBookingForm()
    {
        showTableSelection = false;
    }

    private void ResetBooking()
    {
        isBooked = false;
        showTableSelection = false;
        availableTables.Clear();
        bookingData = new BookingData
        {
            Date = DateOnly.FromDateTime(DateTime.Today.AddDays(1)),
            Time = new TimeOnly(19, 0)
        };
    }

    private async Task CheckBooking()
    {
        showNotFound = false;

        // Проверяем, что оба поля заполнены
        if (string.IsNullOrWhiteSpace(nameCheck) || string.IsNullOrWhiteSpace(phoneCheck))
        {
            showNotFound = true;
            return;
        }

        try
        {
            // Получаем все бронирования из БД
            var allReservations = await RestaurantService.GetAllReservationsAsync();

            // Ищем бронь по имени И последним 4 цифрам телефона
            var reservation = allReservations.FirstOrDefault(r =>
            {
                if (r.User == null) return false;

                var phoneDigits = new string(r.User.PhoneNum.Where(char.IsDigit).ToArray());
                var checkDigits = new string(phoneCheck.Where(char.IsDigit).ToArray());
                var phoneMatch = phoneDigits.EndsWith(checkDigits);
                var nameMatch = r.User.Name.Equals(nameCheck, StringComparison.OrdinalIgnoreCase);

                return phoneMatch && nameMatch;
            });

            if (reservation != null)
            {
                // Преобразуем Reservation в BookingData для отображения
                var dateOnly = DateOnly.FromDateTime(reservation.Date);
                var timeOnly = TimeOnly.FromDateTime(reservation.Date);
                var location = reservation.Table?.TableType?.Title ?? "Зал";

                foundBooking = new BookingData
                {
                    Name = reservation.User?.Name ?? "",
                    Phone = reservation.User?.PhoneNum ?? "",
                    Date = dateOnly,
                    Time = timeOnly,
                    Guests = reservation.GuestCount.ToString(),
                    TableId = reservation.IdTable,
                    TableLocation = location,
                    TableCapacity = reservation.Table?.SeatsCount ?? 0
                };

                bookingFound = true;
            }
            else
            {
                showNotFound = true;
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Ошибка при поиске бронирования: {ex.Message}";
            showNotFound = true;
        }
    }

    private void ResetCheck()
    {
        bookingFound = false;
        phoneCheck = "";
        nameCheck = "";
        showNotFound = false;
    }

    private async Task<List<TableAvailability>> GetAvailableTables(DateOnly date, TimeOnly time, int guestCount)
    {
        var availableTables = new List<TableAvailability>();
        var requestedDateTime = date.ToDateTime(time);

        // Обновляем данные таблиц из БД
        tables = await RestaurantService.GetTablesAsync();

        // Проверяем каждый столик
        foreach (var table in tables)
        {
            // Получаем название локации из TableType
            var location = table.TableType?.Title ?? "Зал";

            // Фильтруем по вместимости - столик должен вмещать количество гостей
            int requiredCapacity = guestCount > 6 ? 6 : guestCount;

            if (table.SeatsCount < requiredCapacity)
                continue;

            // Проверяем, занят ли столик на это время (±2 часа)
            var startTime = requestedDateTime.AddHours(-2);
            var endTime = requestedDateTime.AddHours(2);

            var conflictingReservation = table.Reservations?.FirstOrDefault(r =>
                r.Date >= startTime && r.Date <= endTime
            );

            var availability = new TableAvailability
            {
                TableId = table.IdTable,
                Location = location,
                Capacity = table.SeatsCount,
                IsAvailableNow = conflictingReservation == null,
                IsAvailableInOneHour = false,
                AvailableAt = null
            };

            // Если столик занят сейчас, проверяем, освободится ли он через час
            if (conflictingReservation != null)
            {
                var bookingEndTime = TimeOnly.FromDateTime(conflictingReservation.Date.AddHours(2));
                var oneHourLater = time.AddHours(1);

                if (bookingEndTime <= oneHourLater)
                {
                    availability.IsAvailableInOneHour = true;
                    availability.AvailableAt = bookingEndTime;
                }
            }

            // Добавляем столик если он доступен сейчас или через час
            if (availability.IsAvailableNow || availability.IsAvailableInOneHour)
            {
                availableTables.Add(availability);
            }
        }

        // Сортируем: сначала доступные сейчас, потом по вместимости
        return availableTables
            .OrderByDescending(t => t.IsAvailableNow)
            .ThenBy(t => t.Capacity)
            .ToList();
    }
}
